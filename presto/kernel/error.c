////////////////////////////////////////////////////////////////////////////////
//   C O M M E N T A R Y
////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////////////////
//   D E P E N D E N C I E S
////////////////////////////////////////////////////////////////////////////////

#include "types.h"
#include "chip/hc11regs.h"
#include "chip/locks.h"
#include "error.h"


////////////////////////////////////////////////////////////////////////////////
//   C O N S T A N T S
////////////////////////////////////////////////////////////////////////////////

// this is the memory location for the motor controller
#define MOTOR_LED_PORT *(unsigned char *)(0x7FFF)


////////////////////////////////////////////////////////////////////////////////
//   E X T E R N A L   F U N C T I O N S
////////////////////////////////////////////////////////////////////////////////

void presto_fatal_error(error_number_e err) {
   BYTE delay;

   //  0x80 - motor 3 on    0x08 - motor 3 reverse
   //  0x40 - motor 2 on    0x04 - motor 2 reverse
   //  0x20 - motor 1 on    0x02 - motor 1 reverse
   //  0x10 - motor 0 on    0x01 - motor 0 reverse

   presto_lock();
   // speaker is always an output
   while(1) {
      // toggle speaker
      BITNOT(PORTA,3);
      while(--delay>0) {
         if(delay&0x01) MOTOR_LED_PORT=0xF0&((err&0x0F)<<4);
         else MOTOR_LED_PORT=0x0F|(err&0xF0);
      }
   }
}

////////////////////////////////////////////////////////////////////////////////

